#!/bin/bash

set -e

echo "🚀 开始安装 AI 代码审查工作流..."

# 检查是否在Git仓库中
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "❌ 错误：当前目录不是Git仓库"
    exit 1
fi

# 检查是否在GitHub仓库中
if ! git remote get-url origin 2>/dev/null | grep -q "github.com"; then
    echo "❌ 错误：当前仓库不是GitHub仓库"
    exit 1
fi

# 创建.github/workflows目录
mkdir -p .github/workflows

# 下载AI代码审查工作流文件（添加ngrok警告页面处理）
response=$(curl -s -w "%{http_code}" "$API_URL/api/install/workflow")
http_code="${response: -3}"
content="${response%???}"

# 检查是否是ngrok警告页面
if echo "$content" | grep -q "ERR_NGROK_6024"; then
    echo "⚠️  检测到ngrok安全警告页面，正在跳过..."
    # 重新下载，添加跳过警告的header
    curl -s -H "ngrok-skip-browser-warning: true" -o .github/workflows/ai-review.yml "$API_URL/api/install/workflow"
    
    if [ $? -eq 0 ]; then
        echo "✅ AI代码审查工作流文件已下载到 .github/workflows/ai-review.yml"
    else
        echo "❌ 下载工作流文件失败"
        exit 1
    fi
else
    # 正常处理
    echo "$content" > .github/workflows/ai-review.yml
    
    if [ $? -eq 0 ]; then
        echo "✅ AI代码审查工作流文件已下载到 .github/workflows/ai-review.yml"
    else
        echo "❌ 下载工作流文件失败"
        exit 1
    fi
fi

# 显示下一步操作说明
echo ""
echo "📋 下一步操作："
echo "1. 在GitHub仓库的Settings -> Secrets and variables -> Actions中设置以下secrets："
echo "   - CODE_REVIEW_API_TOKEN: 您的API密钥"
echo "   - CODE_REVIEW_API_URL: API服务地址（例如：$API_URL）"
echo ""
echo "2. 提交并推送更改："
echo "   git add .github/workflows/ai-review.yml"
echo "   git commit -m 'feat: 添加AI代码审查工作流'"
echo "   git push origin main"
echo ""
echo "3. 创建Pull Request测试功能"
echo ""
echo "🎉 AI代码审查系统安装完成！"