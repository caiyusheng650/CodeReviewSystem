# PowerShell AIä»£ç å®¡æŸ¥å·¥ä½œæµå®‰è£…è„šæœ¬

Write-Host "ğŸš€ å¼€å§‹å®‰è£… AI ä»£ç å®¡æŸ¥å·¥ä½œæµ..." -ForegroundColor Green

# æ£€æŸ¥æ˜¯å¦åœ¨Gitä»“åº“ä¸­
if (!(Test-Path ".git")) {
    Write-Host "âŒ é”™è¯¯ï¼šå½“å‰ç›®å½•ä¸æ˜¯Gitä»“åº“" -ForegroundColor Red
    exit 1
}

# æ£€æŸ¥æ˜¯å¦åœ¨GitHubä»“åº“ä¸­
$remoteUrl = git remote get-url origin 2>$null
if (!$remoteUrl -or $remoteUrl -notmatch "github.com") {
    Write-Host "âŒ é”™è¯¯ï¼šå½“å‰ä»“åº“ä¸æ˜¯GitHubä»“åº“" -ForegroundColor Red
    exit 1
}

# åˆ›å»º.github/workflowsç›®å½•
if (!(Test-Path ".github/workflows")) {
    New-Item -ItemType Directory -Path ".github/workflows" -Force | Out-Null
}

# ä¸‹è½½AIä»£ç å®¡æŸ¥å·¥ä½œæµæ–‡ä»¶ï¼ˆå¤„ç†ngrokè­¦å‘Šé¡µé¢ï¼‰
try {
    $headers = @{
        "ngrok-skip-browser-warning" = "true"
    }
    
    $response = Invoke-WebRequest -Uri "$API_URL/api/install/workflow" -Headers $headers
    
    # æ£€æŸ¥æ˜¯å¦æ˜¯ngrokè­¦å‘Šé¡µé¢
    if ($response.Content -match "ERR_NGROK_6024") {
        Write-Host "âš ï¸  æ£€æµ‹åˆ°ngrokå®‰å…¨è­¦å‘Šé¡µé¢ï¼Œæ­£åœ¨ä½¿ç”¨å¤‡ç”¨æ–¹æ³•..." -ForegroundColor Yellow
        
        # ä½¿ç”¨curlä½œä¸ºå¤‡ç”¨æ–¹æ³•
        if (Get-Command "curl" -ErrorAction SilentlyContinue) {
            curl -s -H "ngrok-skip-browser-warning: true" -o ".github/workflows/ai-review.yml" "$API_URL/api/install/workflow"
        } else {
            # å¦‚æœcurlä¹Ÿä¸å¯ç”¨ï¼Œå°è¯•ç›´æ¥ä¸‹è½½
            Invoke-WebRequest -Uri "$API_URL/api/install/workflow" -OutFile ".github/workflows/ai-review.yml"
        }
    } else {
        # æ­£å¸¸ä¿å­˜æ–‡ä»¶
        $response.Content | Out-File -FilePath ".github/workflows/ai-review.yml" -Encoding UTF8
    }
    
    Write-Host "âœ… AIä»£ç å®¡æŸ¥å·¥ä½œæµæ–‡ä»¶å·²ä¸‹è½½åˆ° .github/workflows/ai-review.yml" -ForegroundColor Green
} catch {
    Write-Host "âŒ ä¸‹è½½å·¥ä½œæµæ–‡ä»¶å¤±è´¥: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

# æ˜¾ç¤ºä¸‹ä¸€æ­¥æ“ä½œè¯´æ˜
Write-Host ""
Write-Host "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š" -ForegroundColor Cyan
Write-Host "1. åœ¨GitHubä»“åº“çš„Settings -> Secrets and variables -> Actionsä¸­è®¾ç½®ä»¥ä¸‹secretsï¼š"
Write-Host "   - CODE_REVIEW_API_TOKEN: æ‚¨çš„APIå¯†é’¥"
Write-Host "   - CODE_REVIEW_API_URL: APIæœåŠ¡åœ°å€ï¼ˆä¾‹å¦‚ï¼š$API_URLï¼‰"
Write-Host ""
Write-Host "2. æäº¤å¹¶æ¨é€æ›´æ”¹ï¼š"
Write-Host "   git add .github/workflows/ai-review.yml"
Write-Host "   git commit -m 'feat: æ·»åŠ AIä»£ç å®¡æŸ¥å·¥ä½œæµ'"
Write-Host "   git push origin main"
Write-Host ""
Write-Host "3. åˆ›å»ºPull Requestæµ‹è¯•åŠŸèƒ½"
Write-Host ""
Write-Host "ğŸ‰ AIä»£ç å®¡æŸ¥ç³»ç»Ÿå®‰è£…å®Œæˆï¼" -ForegroundColor Green