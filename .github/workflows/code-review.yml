name: AI Code Review with Reputation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # 为历史 commit 准备

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Collect PR Basic Info + Diff
        id: pr
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          git diff -U20 "$BASE_SHA" "$HEAD_SHA" > diff.patch

          echo "title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "body=${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT

      - name: Collect PR Comments (Simplified)
        id: comments
        uses: actions/github-script@v7
        with:
          script: |
            const { data: raw } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const list = raw.map(c => ({
              author: c.user?.login,
              body: c.body,
              created_at: c.created_at
            }));

            core.setOutput("comments", JSON.stringify(list));

      - name: Collect Author Historical PRs (for Reputation System)
        id: history
        uses: actions/github-script@v7
        with:
          script: |
            const username = "${{ steps.pr.outputs.author }}";
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const { data: prs } = await github.rest.pulls.list({
              owner, repo, state: "all", per_page: 50
            });

            const filtered = prs
              .filter(p => p.user?.login === username)
              .map(p => ({
                number: p.number,
                state: p.state,
                title: p.title,
                created_at: p.created_at,
                closed_at: p.closed_at,
                mergeable: p.mergeable,
                merged: p.merged,
                additions: p.additions,
                deletions: p.deletions
              }));

            core.setOutput("author_prs", JSON.stringify(filtered));

      - name: Build payload for reputation-based review
        id: payload
        env:
          API_URL: ${{ secrets.CODE_REVIEW_API_URL }}
          API_TOKEN: ${{ secrets.CODE_REVIEW_API_TOKEN }}
        run: |
          jq -n \
            --rawfile diff diff.patch \
            --arg pr_title "${{ steps.pr.outputs.title }}" \
            --arg pr_body "${{ steps.pr.outputs.body }}" \
            --arg author "${{ steps.pr.outputs.author }}" \
            --argjson comments "${{ steps.comments.outputs.comments }}" \
            --argjson history "${{ steps.history.outputs.author_prs }}" \
            '{
              review_inputs: {
                diff: $diff,
                pr_title: $pr_title,
                pr_body: $pr_body,
                author: $author,
                comments: $comments
              },
              reputation_inputs: {
                author: $author,
                past_prs: $history
              }
            }' > payload.json

      - name: Call AI Review API
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.CODE_REVIEW_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "${{ secrets.CODE_REVIEW_API_URL }}/api/codereview/review" \
            -o response.json

      - name: Post AI Review Comments
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const res = JSON.parse(fs.readFileSync("response.json", "utf8"));
            const issues = res.issues || [];

            if (issues.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "✔ AI 审查完成：未发现问题。"
              });
              return;
            }

            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `### ⚠️ AI Code Review Issue  
              **文件**: ${issue.file}  
              **行号**: ${issue.line}  
              **问题**: ${issue.description}  
              **建议**: ${issue.suggestion}`
                            });
                          }
