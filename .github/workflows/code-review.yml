name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop, master]
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [main, develop, master]

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          cd .github/tools
          npm install
      
      - name: Get PR information
        id: get_pr_info
        run: |
          # å®‰è£… jqï¼ˆç”¨äºè§£æ JSONï¼‰
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # è·å–PRçš„å·®å¼‚å†…å®¹ï¼ŒåŒ…å«æ›´å¤šä¸Šä¸‹æ–‡è¡Œ(-U20è¡¨ç¤º20è¡Œä¸Šä¸‹æ–‡)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            DIFF_OUTPUT=$(git diff -U20 ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            DIFF_OUTPUT=$(git diff -U20 ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          fi
          echo "$DIFF_OUTPUT" > pr_diff.patch
          echo "diff_file=pr_diff.patch" >> $GITHUB_OUTPUT
          
          # è·å–PRåŸºæœ¬ä¿¡æ¯
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "pr_body=${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
          echo "repo_owner=${{ github.repository_owner }}" >> $GITHUB_OUTPUT
          echo "repo_name=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
          
          # è·å–PRä½œè€…ä¿¡æ¯
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_AUTHOR_ID="${{ github.event.pull_request.user.id }}"
          PR_AUTHOR_NAME="${{ github.event.pull_request.user.name }}"
          PR_AUTHOR_EMAIL="${{ github.event.pull_request.user.email }}"
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "pr_author_id=$PR_AUTHOR_ID" >> $GITHUB_OUTPUT
          echo "pr_author_name=$PR_AUTHOR_NAME" >> $GITHUB_OUTPUT
          echo "pr_author_email=$PR_AUTHOR_EMAIL" >> $GITHUB_OUTPUT
          
          # è·å–PRæ—¶é—´ä¿¡æ¯
          echo "pr_created_at=${{ github.event.pull_request.created_at }}" >> $GITHUB_OUTPUT
          echo "pr_updated_at=${{ github.event.pull_request.updated_at }}" >> $GITHUB_OUTPUT
          echo "pr_merged_at=${{ github.event.pull_request.merged_at }}" >> $GITHUB_OUTPUT
          
          # è·å–åˆ†æ”¯ä¿¡æ¯
          echo "pr_base_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "pr_head_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "pr_base_sha=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          echo "pr_head_sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          
          # è·å–åˆå¹¶çŠ¶æ€
          echo "pr_is_merged=${{ github.event.pull_request.merged }}" >> $GITHUB_OUTPUT
          echo "pr_mergeable=${{ github.event.pull_request.mergeable }}" >> $GITHUB_OUTPUT
          
          # è·å–æäº¤æ•°
          COMMITS_COUNT=$(git rev-list --count ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "pr_commits_count=$COMMITS_COUNT" >> $GITHUB_OUTPUT
          
          # è·å–ä¿®æ”¹çš„æ–‡ä»¶æ•°
          FILES_COUNT=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | wc -l)
          echo "pr_files_count=$FILES_COUNT" >> $GITHUB_OUTPUT
          
          # è·å–ä¿®æ”¹çš„è¡Œæ•°ç»Ÿè®¡
          ADDITIONS=$(git diff --numstat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | awk '{sum += $1} END {print sum}')
          DELETIONS=$(git diff --numstat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | awk '{sum += $2} END {print sum}')
          echo "pr_additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "pr_deletions=$DELETIONS" >> $GITHUB_OUTPUT
          
          # è·å–PRå†å²æäº¤ä¿¡æ¯
          PR_COMMITS=$(git rev-list --pretty=format:"%H|%an|%ae|%ad|%s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "pr_commits<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # è°ƒç”¨GitHub APIè·å–ä½œè€…å†å²æäº¤è®°å½•
          AUTHOR_COMMITS_API="https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/commits?author=$PR_AUTHOR&per_page=10"
          AUTHOR_COMMITS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$AUTHOR_COMMITS_API")
          
          # æå–æäº¤æ‘˜è¦ä¿¡æ¯
          AUTHOR_COMMITS_SUMMARY=$(echo "$AUTHOR_COMMITS" | jq -r '.[] | "SHA: \(.sha[0:8]) | æ¶ˆæ¯: \(.commit.message | split("\n")|first) | æ—¶é—´: \(.commit.committer.date) | ä½œè€…: \(.commit.author.name)"' | head -n 10)
          echo "author_commits_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$AUTHOR_COMMITS_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # è°ƒç”¨GitHub APIè·å–ä½œè€…å†å²PRè®°å½•
          AUTHOR_PRS_API="https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/pulls?state=all&creator=$PR_AUTHOR&per_page=10"
          AUTHOR_PRS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$AUTHOR_PRS_API")
          
          # è§£æå†å²PRçš„å…³é”®ä¿¡æ¯
          AUTHOR_PRS_SUMMARY=$(echo "$AUTHOR_PRS" | jq -r '.[] | 
            "PR #\(.number) | çŠ¶æ€: \(.state) | åˆå¹¶: \(.merged) | æ ‡é¢˜: \(.title) | åˆ›å»ºæ—¶é—´: \(.created_at)" + 
            (if .state == "closed" and (.merged | not) then 
              " | å…³é—­æ—¶é—´: \(.closed_at)"
             else 
              " | å¤‡æ³¨: æ­£å¸¸çŠ¶æ€"
             end)'
          )
          echo "author_prs_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$AUTHOR_PRS_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # è·å–è¢«å…³é—­PRçš„è¯¦ç»†æ‹’ç»åŸå› ï¼ˆæœ€è¿‘2ä¸ªï¼‰
          CLOSED_UNMERGED_PRS=$(echo "$AUTHOR_PRS" | jq -r '.[] | select(.state == "closed" and (.merged | not)) | .number' | head -n 2)
          REJECT_REASONS=""
          for pr_num in $CLOSED_UNMERGED_PRS; do
            COMMENTS_API="https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/pulls/$pr_num/comments"
            PR_COMMENTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$COMMENTS_API")
            # æå–è¯„è®ºæ‘˜è¦
            COMMENTS_SUMMARY=$(echo "$PR_COMMENTS" | jq -r '.[] | "è¯„è®ºè€…: \(.user.login) | å†…å®¹: \(.body | split("\n")|first) | æ—¶é—´: \(.created_at)"' | tail -n 3)
            if [ -n "$COMMENTS_SUMMARY" ]; then
              REJECT_REASONS+="PR #$pr_num çš„æ‹’ç»ç›¸å…³è¯„è®º:\n$COMMENTS_SUMMARY\n\n"
            fi
          done
          echo "author_pr_reject_reasons<<EOF" >> $GITHUB_OUTPUT
          echo -e "$REJECT_REASONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Get PR comments
        id: get_comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });
            
            // å°†è¯„è®ºè½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²å¹¶å­˜å‚¨
            const commentsJson = JSON.stringify(comments);
            core.setOutput('comments', commentsJson);

      - name: Send data to code review API
        id: send_to_api
        env:
          CODE_REVIEW_API_URL: ${{ secrets.CODE_REVIEW_API_URL }}
          CODE_REVIEW_API_TOKEN: ${{ secrets.CODE_REVIEW_API_TOKEN }}
        run: |
          # è¯»å–å·®å¼‚æ–‡ä»¶å†…å®¹
          DIFF_CONTENT=$(cat pr_diff.patch)
          
          # è·å–PRè¯„è®º
          COMMENTS='${{ steps.get_comments.outputs.comments }}'
          
          # æ„å»ºJSONæ•°æ®
          PAYLOAD=$(jq -n \
            --arg diff_content "$DIFF_CONTENT" \
            --arg pr_number "${{ steps.get_pr_info.outputs.pr_number }}" \
            --arg pr_title "${{ steps.get_pr_info.outputs.pr_title }}" \
            --arg pr_body "${{ steps.get_pr_info.outputs.pr_body }}" \
            --arg repo_owner "${{ steps.get_pr_info.outputs.repo_owner }}" \
            --arg repo_name "${{ steps.get_pr_info.outputs.repo_name }}" \
            --arg comments "$COMMENTS" \
            '{
              diff: $diff_content,
              pr_number: $pr_number,
              pr_title: $pr_title,
              pr_body: $pr_body,
              repo_owner: $repo_owner,
              repo_name: $repo_name,
              comments: ($comments | fromjson)
            }')
          
          # å‘é€åˆ°è¿œç¨‹APIå¹¶ä¿å­˜å“åº”
          RESPONSE_FILE="api_response.json"
          HTTP_STATUS=$(curl -s -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${CODE_REVIEW_API_TOKEN}" \
            -d "$PAYLOAD" \
            "${CODE_REVIEW_API_URL:-http://localhost:8000/api/codereview/review}" \
            -o "$RESPONSE_FILE")
          
          # æ£€æŸ¥HTTPçŠ¶æ€ç 
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "APIè°ƒç”¨æˆåŠŸï¼ŒHTTPçŠ¶æ€ç : $HTTP_STATUS"
          else
            echo "APIè°ƒç”¨å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $HTTP_STATUS"
            # å³ä½¿APIè°ƒç”¨å¤±è´¥ï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªç©ºçš„å“åº”æ–‡ä»¶ä»¥é¿å…åç»­æ­¥éª¤å‡ºé”™
            echo '{"issues": []}' > "$RESPONSE_FILE"
          fi
          
          # ä¿å­˜è¯·æ±‚å’Œå“åº”ä¿¡æ¯
          echo "$PAYLOAD" > api_request.json
          echo "request_file=api_request.json" >> $GITHUB_OUTPUT
          echo "response_file=api_response.json" >> $GITHUB_OUTPUT
      
      - name: Post review comments
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // ä»APIå“åº”ä¸­è¯»å–å®¡æŸ¥ç»“æœ
            let reviewData;
            try {
              const responseContent = fs.readFileSync('./api_response.json', 'utf8');
              reviewData = JSON.parse(responseContent);
            } catch (error) {
              console.log('æ— æ³•è§£æAPIå“åº”:', error.message);
              // å¦‚æœæ— æ³•è·å–APIå“åº”ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼
              reviewData = { issues: [] };
            }
            
            const issues = reviewData.issues || [];
            
            // å¦‚æœæ²¡æœ‰å‘ç°é—®é¢˜ï¼Œå‘è¡¨æ­£é¢è¯„è®º
            if (issues.length === 0) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'âœ… ä»£ç å®¡æŸ¥å®Œæˆï¼æœªå‘ç°æ½œåœ¨é—®é¢˜ï¼Œä»£ç ç¬¦åˆè§„èŒƒã€‚'
              });
            } else {
              // ä¸ºæ¯ä¸ªé—®é¢˜åˆ›å»ºå®¡æŸ¥è¯„è®º
              for (const issue of issues) {
                // æ„å»ºè¯„è®ºå†…å®¹ï¼ŒåŒ…å«æ›´å¤šè¯¦ç»†ä¿¡æ¯
                let commentBody = `âš ï¸ **ä»£ç å®¡æŸ¥å‘ç°é—®é¢˜**\n\n`;
                commentBody += `${issue.description}\n\n`;
                commentBody += `**å»ºè®®:** ${issue.suggestion || 'è¯·æ ¹æ®æè¿°è¿›è¡Œç›¸åº”ä¿®æ”¹'}\n\n`;
                commentBody += `**ä¸¥é‡ç¨‹åº¦:** ${issue.severity}\n`;
                
                // å¦‚æœå­˜åœ¨åˆ†ç±»ä¿¡æ¯ï¼Œåˆ™æ·»åŠ åˆ°è¯„è®ºä¸­
                if (issue.category) {
                  commentBody += `**é—®é¢˜ç±»å‹:** ${issue.category}\n`;
                }
                
                try {
                  await github.rest.pulls.createReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: context.issue.number,
                    body: commentBody,
                    commit_id: context.payload.pull_request.head.sha,
                    path: issue.file,
                    line: issue.line
                  });
                } catch (error) {
                  console.log(`æ— æ³•ä¸º ${issue.file}:${issue.line} åˆ›å»ºè¯„è®º:`, error.message);
                  // å¦‚æœæ— æ³•åˆ›å»ºè¡Œè¯„è®ºï¼Œåˆ™åˆ›å»ºæ™®é€šè¯„è®º
                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: `âš ï¸ **ä»£ç å®¡æŸ¥å‘ç°é—®é¢˜**\n\næ–‡ä»¶: \`${issue.file}\` ç¬¬ ${issue.line} è¡Œ\n\né—®é¢˜: ${issue.description}\n\nå»ºè®®: ${issue.suggestion || 'è¯·æ ¹æ®æè¿°è¿›è¡Œç›¸åº”ä¿®æ”¹'}\n\nä¸¥é‡ç¨‹åº¦: ${issue.severity}${issue.category ? `\n\né—®é¢˜ç±»å‹: ${issue.category}` : ''}`
                  });
                }
              }
              
              // æ·»åŠ æ€»ç»“è¯„è®º
              // æ£€æŸ¥æ˜¯å¦æœ‰summary_commentså­—æ®µ
              let summaryComment = `ğŸ“ ä»£ç å®¡æŸ¥å®Œæˆï¼å…±å‘ç° ${issues.length} ä¸ªæ½œåœ¨é—®é¢˜ã€‚è¯·æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†è¯„è®ºå¹¶è¿›è¡Œç›¸åº”ä¿®æ”¹ã€‚`;
              
              if (reviewData.summary && reviewData.summary.summary_comments) {
                summaryComment = `ğŸ“ ä»£ç å®¡æŸ¥å®Œæˆï¼å…±å‘ç° ${issues.length} ä¸ªæ½œåœ¨é—®é¢˜ã€‚\n\n${reviewData.summary.summary_comments}\n\nè¯·æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†è¯„è®ºå¹¶è¿›è¡Œç›¸åº”ä¿®æ”¹ã€‚`;
              }
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summaryComment
              });
            }