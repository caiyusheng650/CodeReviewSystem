name: Cursor AI ä»£ç å®¡æŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: å®‰è£… Cursor CLI
      run: |
        curl https://cursor.com/install -fsS | bash
        echo "$HOME/.cursor/bin" >> $GITHUB_PATH
    
    - name: è¿è¡Œ Cursor Agent - ä»£ç å®¡æŸ¥
      env:
        CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
      run: |
        cursor-agent -p "ä½œä¸ºä¸“ä¸šçš„ä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œè¯·å¯¹å½“å‰Pull Requestè¿›è¡Œå…¨é¢çš„ä»£ç å®¡æŸ¥åˆ†æã€‚
        
        **å®¡æŸ¥ä»»åŠ¡è¯´æ˜ï¼š**
        æ‚¨éœ€è¦åˆ†æPRä¸­çš„æ‰€æœ‰ä»£ç å˜æ›´ï¼Œæä¾›ä¸“ä¸šçš„å®¡æŸ¥æ„è§ï¼Œå¹¶å°†åˆ†æç»“æœç›´æ¥è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚
        
        **å®¡æŸ¥é‡ç‚¹é¢†åŸŸï¼š**
        1. **ä»£ç è´¨é‡** - æ£€æŸ¥ä»£ç è§„èŒƒã€å¯è¯»æ€§ã€å‘½åä¸€è‡´æ€§
        2. **åŠŸèƒ½æ­£ç¡®æ€§** - éªŒè¯é€»è¾‘æ­£ç¡®æ€§ã€è¾¹ç•Œæ¡ä»¶å¤„ç†
        3. **å®‰å…¨æ€§** - è¯†åˆ«æ½œåœ¨çš„å®‰å…¨æ¼æ´å’Œé£é™©
        4. **æ€§èƒ½** - è¯„ä¼°æ€§èƒ½å½±å“å’Œä¼˜åŒ–å»ºè®®
        5. **æ¶æ„è®¾è®¡** - æ£€æŸ¥ä»£ç ç»“æ„åˆç†æ€§å’Œæ‰©å±•æ€§
        6. **æµ‹è¯•è¦†ç›–** - å»ºè®®å¿…è¦çš„æµ‹è¯•ç”¨ä¾‹
        7. **æ–‡æ¡£å®Œæ•´æ€§** - æ£€æŸ¥ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£
        
        **è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š**
        - ä½¿ç”¨Markdownæ ¼å¼è¾“å‡º
        - æŒ‰å®¡æŸ¥é‡ç‚¹åˆ†ç±»ç»„ç»‡å†…å®¹
        - æä¾›å…·ä½“çš„æ”¹è¿›å»ºè®®å’Œä»£ç ç¤ºä¾‹
        - å¯¹æ¯ä¸ªé—®é¢˜æ ‡æ³¨ä¸¥é‡ç¨‹åº¦ï¼ˆé«˜/ä¸­/ä½ï¼‰
        - æœ€åç»™å‡ºæ€»ä½“è¯„ä»·å’Œå»ºè®®
        
        **é‡è¦è¯´æ˜ï¼š**
        - åªè¾“å‡ºå®¡æŸ¥åˆ†æç»“æœï¼Œä¸è¦æ‰§è¡Œä»»ä½•æ–‡ä»¶ä¿®æ”¹æ“ä½œ
        - åˆ†æç»“æœå°†è‡ªåŠ¨å‘å¸ƒåˆ°PRè¯„è®ºåŒº
        - ä¸“æ³¨äºæä¾›æœ‰ä»·å€¼çš„ä¸“ä¸šå»ºè®®" --model gpt-5 > review_result.md
    
    - name: å‘å¸ƒå®¡æŸ¥ç»“æœåˆ°PR
      run: |
        # è¯»å–å®¡æŸ¥ç»“æœå¹¶å‘å¸ƒåˆ°PRè¯„è®º
        if [ -f "review_result.md" ]; then
          echo "æ‰¾åˆ°å®¡æŸ¥ç»“æœæ–‡ä»¶ï¼Œå‡†å¤‡å‘å¸ƒåˆ°PR..."
          REVIEW_CONTENT=$(cat review_result.md)
          
          # æ„å»ºå®Œæ•´çš„è¯„è®ºå†…å®¹
          COMMENT="## ğŸ¤– Cursor AI ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n"
          COMMENT+="**å®¡æŸ¥æ—¶é—´**: $(date)\\n"
          COMMENT+="**å®¡æŸ¥æ¨¡å‹**: GPT-5\\n"
          COMMENT+="**å˜æ›´æ–‡ä»¶æ•°**: $(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | wc -l)\\n\n"
          COMMENT+="$REVIEW_CONTENT"
          
          # å‘å¸ƒè¯„è®ºåˆ°PR
          echo "$COMMENT" | gh pr comment ${{ github.event.pull_request.number }} --body-file -
          echo "å®¡æŸ¥ç»“æœå·²å‘å¸ƒåˆ°PRè¯„è®ºåŒº"
        else
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°å®¡æŸ¥ç»“æœæ–‡ä»¶"
          exit 1
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}