name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  ai_review:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Normalize PR Metadata
      - name: Normalize PR Metadata
        id: meta
        run: |
          echo "actor=${{ github.actor }}" >> $GITHUB_ENV

          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"

          TITLE="${TITLE:-""}"
          BODY="${BODY:-""}"

          echo "title_b64=$(printf "%s" "$TITLE" | base64 -w0)" >> $GITHUB_ENV
          echo "body_b64=$(printf "%s" "$BODY" | base64 -w0)" >> $GITHUB_ENV

          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "repo_owner=${{ github.repository_owner }}" >> $GITHUB_ENV
          echo "repo_name=$(basename '${{ github.repository }}')" >> $GITHUB_ENV

      # 3) Generate diff safely
      - name: Generate diff safely (Base64)
        id: diff
        run: |
          BASE="${{ github.base_ref }}"
          if [ -z "$BASE" ]; then
            BASE="origin/main"
          fi

          DIFF_RAW=$(git diff "origin/$BASE"...HEAD)

          DIFF_SIZE=$(echo "$DIFF_RAW" | wc -c)
          MAX_SIZE=5000000

          if [ "$DIFF_SIZE" -gt "$MAX_SIZE" ]; then
            echo "Diff too large, truncating to 5MB..."
            DIFF_RAW=$(echo "$DIFF_RAW" | head -c $MAX_SIZE)
          fi

          DIFF_B64=$(printf "%s" "$DIFF_RAW" | base64 -w0)
          echo "diff_b64=$DIFF_B64" >> $GITHUB_ENV

      # 4) Build JSON payload
      - name: Build JSON Payload
        run: |
          cat <<EOF > payload.json
          {
            "diff_base64": "${diff_b64}",
            "pr_number": "${pr_number}",
            "pr_title_b64": "${title_b64}",
            "pr_body_b64": "${body_b64}",
            "repo_owner": "${repo_owner}",
            "repo_name": "${repo_name}",
            "author": "${actor}",
            "comments": []
          }
          EOF

      # 5) Send request to AI Review API
      - name: Send to AI Review API
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.CODE_REVIEW_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json \
            "${{ secrets.CODE_REVIEW_API_URL }}/api/codereview/review" \
            -o response.json

      # 6) Print Final Response
      
      - name: Format review message
        id: fm
        run: |
          echo "ç”Ÿæˆè¯„è®º markdown..."

          BODY=$(cat response.json | jq -r '
            "## ğŸ¤– AI Code Review ç»“æœ\n" +
            "**ä¿¡èª‰åˆ†**: \(.author_reputation)\n" +
            "**åˆå¹¶å»ºè®®**: \(.conclusion)\n\n" +
            "### é—®é¢˜åˆ—è¡¨\n" +
            ( .issues | map(
                "- **æ–‡ä»¶**: " + .file +
                " (è¡Œ: " + (.line|tostring) + ")\n" +
                "  - ä¸¥é‡ç¨‹åº¦: **" + .severity + "**\n" +
                "  - æè¿°: " + .description + "\n" +
                "  - å»ºè®®: " + .suggestion + "\n"
              ) | join("\n")
            )
          ')

          # ä¿å­˜è¯„è®ºå†…å®¹
          printf "%s" "$BODY" > comment.md
          echo "COMMENT_BODY<<EOF" >> $GITHUB_ENV
          cat comment.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ env.PR_NUMBER }}
          body: ${{ env.COMMENT_BODY }}
          token: ${{ secrets.GITHUB_TOKEN }}
          edit-mode: replace # ä¸é‡å¤åˆ·å±ï¼Œåªæ›´æ–°
          comment-identifier: ai-review
