name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  ai_review:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout Repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Capture Metadata
      - name: Normalize PR Metadata
        id: meta
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "REPO_OWNER=${{ github.repository_owner }}" >> $GITHUB_ENV
          echo "REPO_NAME=${{ github.event.pull_request.head.repo.name }}" >> $GITHUB_ENV
          echo "AUTHOR=${{ github.actor }}" >> $GITHUB_ENV

          # Base64 encoding of title/body
          printf "%s" "${{ github.event.pull_request.title }}" | base64 -w0 > title.b64
          printf "%s" "${{ github.event.pull_request.body }}" | base64 -w0 > body.b64

      # 3) Capture README Content (NEW STEP)
      - name: Capture README Content
        run: |
          # Ê£ÄÊü• README.md ÊòØÂê¶Â≠òÂú®ÔºåÂ¶ÇÊûúÂ≠òÂú®ÂàôËøõË°åÁºñÁ†ÅÔºåÂê¶ÂàôÂàõÂª∫‰∏Ä‰∏™Á©∫Êñá‰ª∂
          if [ -f "README.md" ]; then
            echo "README.md found. Encoding content."
            printf "%s" "$(cat README.md)" | base64 -w0 > readme.b64
          else
            echo "README.md not found. Creating empty placeholder file."
            touch readme.b64
          fi

      # 4) Generate diff safely (Original Step 3, Renumbered)
      - name: Generate diff safely
        run: |
          BASE="${{ github.base_ref }}"
          if [ -z "$BASE" ]; then BASE="origin/main"; fi

          DIFF_RAW=$(git diff "origin/$BASE"...HEAD)

          # Prevent oversize
          DIFF_SIZE=$(echo "$DIFF_RAW" | wc -c)
          MAX=5000000
          if [ "$DIFF_SIZE" -gt "$MAX" ]; then
            echo "‚ö†Ô∏è Diff >5MB, truncating."
            DIFF_RAW=$(echo "$DIFF_RAW" | head -c $MAX)
          fi

          printf "%s" "$DIFF_RAW" | base64 -w0 > diff.b64

      # 5) Build JSON Payload (Original Step 4, Renumbered and Updated)
      - name: Build JSON Payload
        run: |
          cat <<EOF > payload.json
          {
            "diff_base64": "$(cat diff.b64)",
            "pr_number": "${{ env.PR_NUMBER }}",
            "pr_title_b64": "$(cat title.b64)",
            "pr_body_b64": "$(cat body.b64)",
            "readme_b64": "$(cat readme.b64)",  // NEW FIELD
            "repo_owner": "${{ env.REPO_OWNER }}",
            "repo_name": "${{ env.REPO_NAME }}",
            "author": "${{ env.AUTHOR }}",
            "comments": []
          }
          EOF

      # 6) Send to AI Review API (Original Step 5, Renumbered)
      - name: Call AI Review API
        run: |
          curl -v -X POST \
            -H "X-Api-Key: ${{ secrets.CODE_REVIEW_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json \
            "${{ secrets.CODE_REVIEW_API_URL }}/api/codereview/review" \
            -o response.json

          echo "=== API Response ==="
          cat response.json
          echo "===================="

      # 7) Format markdown (Original Step 6, Renumbered)
      - name: Generate Review Markdown
        run: |
          jq -r '
            "## ü§ñ AI Code Review\n" +
            "**ÂêàÂπ∂Âª∫ËÆÆ**: \(.conclusion)\n\n" +
            "### ÈóÆÈ¢òÂàóË°®\n" +
            (
              .issues | map(
                "- **Êñá‰ª∂**: " + .file +
                " (Ë°å " + (.line|tostring) + ")\n" +
                " ¬†- ‰∏•ÈáçÁ®ãÂ∫¶: **" + .severity + "**\n" +
                " ¬†- ÊèèËø∞: " + .description + "\n" +
                " ¬†- Âª∫ËÆÆ: " + .suggestion + "\n"
              ) | join("\n")
            )
          ' response.json > comment.md

          echo "Markdown generated:"
          cat comment.md

      # 8) Add inline comments (Original Step 7, Renumbered)
      - name: Add inline comments
        run: |
          HEAD_SHA=$(git rev-parse HEAD)
          echo "HEAD_SHA=$HEAD_SHA"

          jq -c '.issues[]' response.json | while read -r issue; do
            file=$(echo "$issue" | jq -r '.file')
            line=$(echo "$issue" | jq -r '.line')
            desc=$(echo "$issue" | jq -r '.description')
            sug=$(echo "$issue" | jq -r '.suggestion')
            sev=$(echo "$issue" | jq -r '.severity')

            body="**AI ‰ª£Á†ÅÂÆ°Êü•ÊÑèËßÅ** **ÊèèËø∞**: $desc  
                    **Âª∫ËÆÆ**: $sug  
                    **‰∏•ÈáçÁ®ãÂ∫¶**: $sev"

            echo "Adding inline comment to $file:$line"

            gh api \
              repos/${{ github.repository }}/pulls/${{ env.PR_NUMBER }}/comments \
              -X POST \
              -f body="$body" \
              -f commit_id="$HEAD_SHA" \
              -f path="$file" \
              -F line="$line"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9) Create Summary Comment (Original Step 8, Renumbered)
      - name: Create or update summary comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.PR_NUMBER }}
          body-file: comment.md
          edit-mode: replace
          search: "## ü§ñ AI Code Review"