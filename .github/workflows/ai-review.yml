name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  ai_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ÈúÄË¶ÅÂÆåÊï¥ÂéÜÂè≤ÊâçËÉΩ diff

      - name: Normalize PR Metadata
        id: meta
        run: |
          echo "actor=${{ github.actor }}" >> $GITHUB_ENV
          
          # Â¶ÇÊûú title Êàñ body ÊòØ nullÔºåÂàôÊõøÊç¢‰∏∫Á©∫Â≠óÁ¨¶‰∏≤
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"

          TITLE="${TITLE:-""}"
          BODY="${BODY:-""}"

          # Base64 encode Êù•‰øùËØÅ JSON ÂÆâÂÖ®
          echo "title_b64=$(printf "%s" "$TITLE" | base64 -w0)" >> $GITHUB_ENV
          echo "body_b64=$(printf "%s" "$BODY" | base64 -w0)" >> $GITHUB_ENV

          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "repo_owner=${{ github.repository_owner }}" >> $GITHUB_ENV
          echo "repo_name=$(basename '${{ github.repository }}')" >> $GITHUB_ENV

      - name: Generate diff safely (Base64)
        id: diff
        run: |
          # diff Âü∫Á∫øÔºàÈò≤Ê≠¢ fork ÊÉÖÂÜµ base_ref ‰∏çÂ≠òÂú®Ôºâ
          BASE="${{ github.base_ref }}"
          if [ -z "$BASE" ]; then
            BASE="origin/main"
          fi

          DIFF_RAW=$(git diff "origin/$BASE"...HEAD)

          echo "Diff line count: $(echo "$DIFF_RAW" | wc -l)"
          echo "Diff size: $(echo "$DIFF_RAW" | wc -c) bytes"

          # Ë∂ÖËøá 5MB Ëá™Âä®Êà™Êñ≠ÔºåÈÅøÂÖç Runner Âç°Ê≠ª
          DIFF_SIZE=$(echo "$DIFF_RAW" | wc -c)
          MAX_SIZE=5000000
          if [ "$DIFF_SIZE" -gt "$MAX_SIZE" ]; then
            echo "Diff too large, truncating to 5MB..."
            DIFF_RAW=$(echo "$DIFF_RAW" | head -c $MAX_SIZE)
          fi

          DIFF_B64=$(printf "%s" "$DIFF_RAW" | base64 -w 0)
          echo "diff_b64=$DIFF_B64" >> $GITHUB_ENV

      - name: Build JSON Payload
        run: |
          cat <<EOF > payload.json
          {
            "diff_base64": "${diff_b64}",
            "pr_number": "${pr_number}",
            "pr_title_b64": "${title_b64}",
            "pr_body_b64": "${body_b64}",
            "repo_owner": "${repo_owner}",
            "repo_name": "${repo_name}",
            "author": "${actor}",
            "comments": []
          }
          EOF
          
          echo "=== API Payload (payload.json) ==="
          cat payload.json
          echo "=================================="

      # 7) Send to AI Review API
      - name: Call AI Review API
        run: |
          curl -v -X POST \
            -H "X-Api-Key: ${{ secrets.CODE_REVIEW_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json \
            "${{ secrets.CODE_REVIEW_API_URL }}/api/codereview/review" \
            -o response.json

      - name: Display AI Review Response
        run: |
          echo "===== AI REVIEW RESULT ====="
          cat response.json
          echo "===================================="

      # 8) Format markdown
      - name: Generate Review Markdown
        run: |
          # È¶ñÂÖàÊ†πÊçÆ‰∏•ÈáçÁ®ãÂ∫¶ÁîüÊàêconclusion
          jq '
            .conclusion = (
              if (.issues | to_entries | map(.value.severity) | any(. == "‰∏•Èáç" or . == "‰∏≠Á≠â")) 
              then "‰∏çÂª∫ËÆÆÂêàÂπ∂" 
              else "Âª∫ËÆÆÂêàÂπ∂" 
              end
            )
          ' response.json > temp.json && mv temp.json response.json
          
          # ÁÑ∂ÂêéÁîüÊàêMarkdownÔºàÈáçÁÇπÂ§ÑÁêÜÂéÜÂè≤Êú™‰øÆÂ§çÈóÆÈ¢òÔºâ
          jq -r '
            "## ü§ñ AI ‰ª£Á†ÅÂÆ°Êü•ÊÑèËßÅ \n\n" +
            "**ÂêàÂπ∂Âª∫ËÆÆ**: \(.conclusion)\n\n" +
            "### ÈóÆÈ¢òÂàóË°®\n" +
            (
              .issues | to_entries | map(
                # ÂØπÂéÜÂè≤Êú™‰øÆÂ§çÈóÆÈ¢òÊ∑ªÂä†ÈÜíÁõÆÊ†áËØÜ
                "- **Êñá‰ª∂**: " + .value.file +
                " (Ë°å " + (.value.line|tostring) + ")\n" +
                "  - Á±ªÂûã: **" + .value.bug_type + "**\n" +
                "  - Á®ãÂ∫¶: **" + .value.severity + "**\n" +
                # ÂéÜÂè≤ÈóÆÈ¢òË°•ÂÖÖÊèêÁ§∫ÊñáÂ≠ó
                (if .value.historical_mention == true then "  - ÊèêÁ§∫: Ê≠§ÈóÆÈ¢òÂ∑≤Âú®ÂéÜÂè≤ÂÆ°Êü•‰∏≠Â§öÊ¨°ÊèêÂèäÔºåËØ∑‰ºòÂÖà‰øÆÂ§ç\n" else "" end) +
                "  - ÊèèËø∞: " + .value.description + "\n" +
                "  - Âª∫ËÆÆ: " + .value.suggestion + "\n"
              ) | join("\n")
            )
          ' response.json > comment.md

          echo "Markdown generated:"
          cat comment.md


      # 9) Add inline comments
      - name: Add inline comments
        run: |
          HEAD_SHA=$(git rev-parse HEAD)
          echo "HEAD_SHA=$HEAD_SHA"

          jq -c '.issues[]' response.json | while read -r issue; do
            file=$(echo "$issue" | jq -r '.file')
            line=$(echo "$issue" | jq -r '.line')
            type=$(echo "$issue" | jq -r '.bug_type')
            desc=$(echo "$issue" | jq -r '.description')
            sug=$(echo "$issue" | jq -r '.suggestion')
            sev=$(echo "$issue" | jq -r '.severity')
            # ÊèêÂèñÂéÜÂè≤Êú™‰øÆÂ§çÊ†áËÆ∞
            historical=$(echo "$issue" | jq -r '.historical_mention')

            # ÂØπÂéÜÂè≤Êú™‰øÆÂ§çÈóÆÈ¢òÊ∑ªÂä†ÁâπÊÆäÂâçÁºÄÂíåÊèêÁ§∫
            if [ "$historical" = "true" ]; then
              # ÂàõÂª∫Â∏¶ÊúâÊç¢Ë°åÁöÑheaderÂíåÊèêÁ§∫
              header="**‚ö†Ô∏è [ÂéÜÂè≤Êú™‰øÆÂ§çÈóÆÈ¢ò] ‚ö†Ô∏è**"
              extra_note=$'\n\n**ÊèêÁ§∫**: Ê≠§ÈóÆÈ¢òÂ∑≤Âú®ÂéÜÂè≤ÂÆ°Êü•‰∏≠Â§öÊ¨°ÊèêÂèäÔºåËØ∑‰ºòÂÖàÂ§ÑÁêÜ'
            else
              header="**AI ‰ª£Á†ÅÂÆ°Êü•ÊÑèËßÅ**"
              extra_note=""
            fi

            # ÊãºÊé•ËØÑËÆ∫ÂÜÖÂÆπÔºàÂåÖÂê´ÂéÜÂè≤ÈóÆÈ¢òÊ†áËØÜÔºâ- ‰ΩøÁî®Â§öË°åprintfÁ°Æ‰øùÊç¢Ë°åÊ≠£Á°ÆÂ§ÑÁêÜ
            if [ "$historical" = "true" ]; then
              body=$(printf '%s\n\n**Á±ªÂûã**: %s\n**ÊèèËø∞**: %s\n**Âª∫ËÆÆ**: %s\n**Á®ãÂ∫¶**: %s\n\n**ÊèêÁ§∫**: Ê≠§ÈóÆÈ¢òÂ∑≤Âú®ÂéÜÂè≤ÂÆ°Êü•‰∏≠Â§öÊ¨°ÊèêÂèäÔºåËØ∑‰ºòÂÖàÂ§ÑÁêÜ' \
                "**‚ö†Ô∏è [ÂéÜÂè≤Êú™‰øÆÂ§çÈóÆÈ¢ò] ‚ö†Ô∏è**" "$type" "$desc" "$sug" "$sev")
            else
              body=$(printf '%s\n\n**Á±ªÂûã**: %s\n**ÊèèËø∞**: %s\n**Âª∫ËÆÆ**: %s\n**Á®ãÂ∫¶**: %s' \
                "**AI ‰ª£Á†ÅÂÆ°Êü•ÊÑèËßÅ**" "$type" "$desc" "$sug" "$sev")
            fi

            echo "Attempting to add inline comment to $file:$line"

            # ‰øùÁïôÂéüÊúâÁöÑÈîôËØØÂ§ÑÁêÜÈÄªËæë
            if ! gh api \
              repos/${{ github.repository }}/pulls/${{ env.PR_NUMBER }}/comments \
              -X POST \
              -f body="$body" \
              -f commit_id="$HEAD_SHA" \
              -f path="$file" \
              -F line="$line" > /dev/null 2>&1
            then
              echo "‚ùå ERROR: Failed to add inline comment to $file:$line"
            else
              echo "‚úÖ Success: Added inline comment to $file:$line"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 10) Create Summary Comment
      - name: Create or update summary comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ env.PR_NUMBER }}
          body-file: comment.md
          edit-mode: replace