

### 页面整体结构（基于React/Vue等前端框架）
页面采用「**概览区 → 汇总区 → 详情区 → 原始数据区**」的信息分层，同时强化「历史未修复问题」的视觉标识。


## 1. 页面头部（导航+标题）
```
【面包屑】审查记录 > PR #21
【页面标题】PR #21 代码审查结果
【辅助操作】
  - 按钮：「重新触发审查」（若状态为completed/failed）
  - 按钮：「导出审查报告」（导出为JSON/Markdown）
```


## 2. PR基础信息概览（顶部卡片）
用**浅色卡片+信息分栏**展示PR核心信息，状态做视觉区分：
```
┌─────────────────────────────────────────────────────────────────────┐
│ 【PR基本信息】                                                        │
│  PR编号：#21  │  仓库：caiyusheng650/CodeReviewSystem                │
│  作者：caiyusheng650  │  提交时间：2025-11-19 16:45                  │
│  审查状态：【已完成】（绿色标签）  │  审查耗时：1分31秒               │
└─────────────────────────────────────────────────────────────────────┘
```
- 状态样式：
  - `pending`：黄色标签+“待审查”
  - `processing`：蓝色标签+“审查中”（带加载动画）
  - `completed`：绿色标签+“已完成”
  - `failed`：红色标签+“审查失败”（hover显示失败原因）


## 3. 审查核心汇总区（统计卡片+合并建议）
用**彩色统计卡片**展示关键数据，合并建议醒目显示：
```
┌─────────────┬─────────────┬─────────────┬─────────────┐
│ 严重问题    │ 中等问题    │ 轻微问题    │ 表扬项      │
│ 【2】（红底）│ 【3】（橙底）│ 【1】（黄底）│ 【1】（绿底）│
└─────────────┴─────────────┴─────────────┴─────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 【合并建议】：不建议合并（大字体+红色边框）                           │
│ 【风险等级】：高风险（红色标签）                                     │
│ 【说明】：存在2个严重安全/逻辑问题，含1个历史未修复bug，需优先修复   │
└─────────────────────────────────────────────────────────────────────┘
```


## 4. 问题详情区（标签页+折叠面板）
提供「按文件分类」「按问题类型分类」两个标签页，支持筛选/搜索：

### 4.1 标签页切换栏
```
◉ 按文件分类   ◯ 按问题类型分类   [筛选] [搜索框：搜索文件/问题描述]
```
- 筛选功能：支持选择“严重程度（严重/中等/轻微）”“是否历史未修复”


### 4.2 「按文件分类」标签页（默认）
每个文件对应一个**折叠面板**，面板标题显示文件名+该文件的问题数量：
```
▼ .github/workflows/ai-review.yml（4个问题）
  ├─ 行161 · 安全漏洞（严重）【历史未修复】
     ├── 描述：存在XSS风险，动态内容未转义
     ├── 建议：添加HTML转义函数
     ├── 代码示例：
         问题代码：`body=$(printf "**AI意见**%s" "$user_input")`
         优化代码：`body=$(printf "**AI意见**%s" "$(escape "$user_input")")`
  ├─ 行168 · 逻辑缺陷（严重）
     ├── 描述：错误处理缺失，会导致工作流异常终止
     ├── 建议：添加重试机制+详细日志
  ├─ 行160 · 静态缺陷（轻微）
  └─ 行165 · 可维护性问题（表扬）
```
- 样式细节：
  - 「历史未修复」问题：前缀加⚠️图标+红色“历史未修复”标签
  - 严重程度标签：严重（红）、中等（橙）、轻微（黄）、表扬（绿）
  - 代码示例：用语法高亮的代码块展示，支持复制


### 4.3 「按问题类型分类」标签页
按问题类型（安全漏洞/逻辑缺陷等）分组，结构同文件分类：
```
▼ 安全漏洞（2个问题）
  ├─ .github/workflows/ai-review.yml（行161）【历史未修复】
  └─ backend/app/install/router.py（行22）
▼ 逻辑缺陷（1个问题）
  └─ .github/workflows/ai-review.yml（行168）
```


## 5. Agent输出&原始数据区（折叠面板）
默认折叠，供技术人员查看原始数据：
```
▼ Agent输出记录（10个Agent）
  ├─ ReputationAssessmentAgent：
     { "risk_level": "high", "focus_areas": ["security"], ... }
  ├─ StaticAnalysisAgent：
     [ { "file": "...", "line": 160, ... } ]
  └─ ...（其余Agent）

▼ 最终聚合结果（JSON）
  {
    "0": { "file": "...", "line": 161, "historical_mention": true, ... },
    "1": { ... }
  }
```
- 功能：JSON内容支持格式化展开/折叠、复制。


## 交互细节强化
1. **问题跳转**：行号支持点击跳转到PR对应的代码行（若后端提供代码链接）；
2. **问题标记**：支持“标记为已修复”（前端临时标记，可选同步后端）；
3. **响应式适配**：移动端将标签页改为下拉选择，统计卡片改为垂直排列；
4. **加载状态**：审查中（processing）时，问题区域显示骨架屏+“审查中...”提示。


## 样式参考（配色&组件）
- 主色调：用后端系统的主色（如蓝色），问题严重程度用辅助色（红/橙/黄/绿）；
- 组件库：可基于Ant Design/Element UI实现，比如：
  - 概览区：`Card`组件；
  - 统计卡片：`Statistic`+`Tag`组件；
  - 问题列表：`Collapse`+`List`组件；
  - 代码块：`Code`组件（带语法高亮）。


数据表模型


class ReviewStatus(str, Enum):
    """审查状态枚举"""
    PENDING = "pending"
    PROCESSING = "processing"
    COMPLETED = "completed"
    FAILED = "failed"

class CodeReviewBase(BaseModel):
    """代码审查基础模型"""
    github_action_id: str = Field(..., description="GitHub Action ID")
    pr_number: int = Field(..., description="Pull Request编号")
    repo_owner: str = Field(..., description="仓库所有者")
    repo_name: str = Field(..., description="仓库名称")
    author: str = Field(..., description="PR作者")
    diff_content: str = Field(..., description="代码差异内容")
    pr_title: str = Field(..., description="PR标题")
    pr_body: str = Field(..., description="PR正文")
    readme_content: str = Field(..., description="README内容")
    comments: List[Dict[str, Any]] = Field(..., description="评论列表")

class CodeReviewInDB(CodeReviewBase):
    """数据库中的代码审查模型"""
    id: Optional[PyObjectId] = Field(default_factory=PyObjectId, alias="_id")
    created_at: datetime = Field(default_factory=datetime.utcnow, description="创建时间")
    updated_at: datetime = Field(default_factory=datetime.utcnow, description="更新时间")
    status: ReviewStatus = Field(default=ReviewStatus.PENDING, description="审查状态")
    
    # 存储各个agent的输出结果（原始JSON字符串）
    agent_outputs: List[str] = Field(default_factory=list, description="各agent的输出结果列表（JSON字符串）")
    
    # 存储最终的聚合结果（原始JSON字符串）
    final_result: Optional[str] = Field(default=None, description="最终聚合结果（JSON字符串）")
    
    # 性能统计
    agent_count: int = Field(default=0, description="参与审查的agent数量")

    username: str = Field(..., description="请求头API token所属的用户名")
    
    model_config = {
        "populate_by_name": True,
        "json_encoders": {ObjectId: str, datetime: lambda v: v.isoformat() if v else None},
        "arbitrary_types_allowed": True
    }